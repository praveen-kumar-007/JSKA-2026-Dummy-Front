<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional ID Card - DDKA & JSKA</title>
    <style>
        :root {
            /* Variables for easy customization */
            --primary-red: #d32f2f;
            --primary-green: #2e7d32;
            --accent-orange: #f57c00;
            --ddka-blue: #1a4a8c;
            --jska-gold: #fbc02d;
            --text-main: #222;
            --border-light: #ddd;
            --card-width: 400px;
            --card-height: 660px; /* taller so all content fits comfortably inside the frame */
        }

        body {
            background-color: #e0e0e0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            font-family: 'Arial', sans-serif;
        }

        /* Card Container */
        .id-card {
            width: var(--card-width);
            height: var(--card-height);
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
            border: 3px solid var(--ddka-blue);
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
            padding: 10px 18px 14px 18px; /* slightly less bottom padding so content sits higher */
        }

        /* DDKA watermark behind all content */
        .id-card::before {
            content: "";
            position: absolute;
            inset: 0;
            background-image: url('https://res.cloudinary.com/dmmll82la/image/upload/v1766683651/ddka-logo_ywnhyh.png');
            background-repeat: no-repeat;
            background-position: center 82%; /* move watermark even further down */
            background-size: 260px 260px;
            opacity: 0.15; /* 15% visibility */
            pointer-events: none;
            z-index: 0;
        }

        /* ensure real content sits above the watermark */
        .id-card > * {
            position: relative;
            z-index: 1;
        }

        /* Top Header */
        .main-header {
            text-align: center;
            padding: 6px 12px;
            margin-bottom: 6px;
            background: #fff;
            border-radius: 10px;
            border: 2px solid var(--ddka-blue);
            border-top-color: var(--primary-red);
            border-bottom-color: var(--primary-green);
            border-left-color: var(--accent-orange);
            border-right-color: var(--accent-orange);
        }

        .jska-title {
            color: var(--primary-red);
            font-size: 18px;
            font-weight: 900;
            margin: 0;
            text-transform: uppercase;
        }

        .ddka-subtitle {
            color: var(--primary-green);
            font-size: 14px;
            font-weight: 800;
            margin: 2px 0;
        }

        /* Logo and Title Section */
        .logo-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 15px 2px 15px;
        }

        .logo {
            width: 72px;
            height: 72px;
            aspect-ratio: 1/1;
            border-radius: 50%;
            border: 2px solid #eee;
            display: inline-flex;
            flex: 0 0 auto;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            text-align: center;
            background: #f9f9f9;
            overflow: hidden;
        }

        .logo img {
            width: auto;
            height: 100%;
            aspect-ratio: 1/1;
            object-fit: cover;
            border-radius: 50%;
            display: block;
        }

        /* Remove outer border on the DDKA and JSKA logo containers */
        .ddka-logo { border: none; color: var(--ddka-blue); }
        .jska-logo { border: none; color: var(--primary-red); }

        .official-title {
            text-align: center;
            flex-grow: 1;
        }

        .official-title h2 {
            color: var(--accent-orange);
            font-size: 22px;
            margin: 2px 0 0 0;
            text-transform: uppercase;
            line-height: 1.15;
            letter-spacing: 0.8px;
        }

        /* Body Section */
        .card-body {
            padding: 6px 20px 10px 20px; /* move photo block closer to title */
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            row-gap: 8px;
        }

        .info-fields {
            width: 100%;
        }

        .photo-space {
            width: 110px;
            height: 130px;
            border: 2px solid var(--ddka-blue);
            border-top-color: var(--primary-red);
            border-bottom-color: var(--primary-green);
            border-left-color: var(--accent-orange);
            border-right-color: var(--accent-orange);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            color: #777;
            background: #fafafa;
            overflow: hidden;
            margin: 0 auto 6px auto; /* center photo above details */
        }

        .photo-space img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .field {
            margin-bottom: 8px;
            font-size: 15px;
            color: var(--text-main);
            display: flex;
            align-items: center;
        }
        /* only show dotted border when field is empty */
        .field.empty { border-bottom: 1px dotted #ccc; padding-bottom:6px; }

        .label {
            font-weight: bold;
            width: 115px; /* enough space so text doesn't wrap */
            display: inline-block;
            white-space: nowrap; /* keep label on one line, allow value to wrap */
        }

        .value {
            color: #0b0b0b;
            flex: 1;
            font-weight: 700;
            font-size: 16px;
            letter-spacing: 0.2px;
        }

        /* certificate name inside description */
        #certified-name {
            font-weight: 700;
            color: #0b0b0b;
            font-size: 15px;
        }

        /* Descriptive Text Section */
        @media print {
            .editor-panel, .toolbar { display: none !important; }
            body { background: #fff; }
        }

        .toolbar { display:flex; gap:8px; align-items:center; margin-top:8px; }
        .toolbar button { padding:6px 10px; background:#1a4a8c; color:#fff; border:none; border-radius:4px; cursor:pointer; }
        .toolbar button.secondary { background:#f57c00; }
        .toolbar button.ghost { background:#fff; color:#1a4a8c; border:1px solid #ddd; }

        /* Descriptive Text Section */
        .description-text {
            padding: 6px 14px 0 14px;
            font-size: 13px; /* increased by two points */
            line-height: 1.4;
            font-weight: bold;
            color: #333;
        }

        .dotted-line {
            border-bottom: 2px dotted #000;
            display: inline-block;
            min-width: 120px;
        }

        /* Footer / Signatures */
        .signature-area {
            margin-top: 0; /* move signatures slightly further up */
            padding: 2px 10px 0;
            text-align: center;
        }

        .sig-official-header {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 40px;
            text-decoration: underline;
        }

        .sig-grid {
            display: flex;
            justify-content: space-around;
            align-items: flex-end;
        }

        .sig-box {
            width: 30%;
            font-size: 10px;
            line-height: 1.15;
        }

        .sig-name {
            font-weight: bold;
            font-size: 11px;
            margin-bottom: 2px;
        }

        .sig-img {
            display: block;
            height: 38px;
            max-width: 140px;
            margin: 0 auto 6px;
            object-fit: contain;
        }

        .sig-line {
            border-top: 1.5px solid #000;
            margin-top: 5px;
            padding-top: 3px;
        }

        .footer-banner {
            background-color: #fff;
            color: var(--primary-green);
            text-align: center;
            font-weight: 900;
            font-size: 12px;
            padding: 4px 0 0 0; /* reduce footer height so everything fits neatly */
            text-transform: uppercase;
        }

        /* Export mode: lock layout but keep watermark visible */
        body.exporting { background: #fff; }
        body.exporting .id-card { box-shadow: none; }
    </style>
</head>
<body>

    <div class="id-card">
        <header class="main-header">
            <h1 class="jska-title">DHANBAD DISTRICT KABADDI ASSOCIATION</h1>
            <p class="ddka-subtitle">Affiliated - Jharkhand State Kabaddi Association (AKFI)</p>
            <p class="ddka-subtitle">Org - DDKA</p>
        </header>

        <div class="logo-row">
            <div class="logo ddka-logo">
                <img crossorigin="anonymous" src="https://res.cloudinary.com/dmmll82la/image/upload/v1766683651/ddka-logo_ywnhyh.png" alt="DDKA Logo">
            </div>
            <div class="official-title">
                <h2>Kabaddi Technical<br>Official</h2>
            </div>
            <div class="logo jska-logo">
                <img crossorigin="anonymous" src="https://res.cloudinary.com/dmmll82la/image/upload/v1767452076/WhatsApp_Image_2026-01-03_at_1.57.17_PM_liagkr.jpg" alt="JSKA Logo">
            </div>
        </div>

        <div class="card-body">
            <div class="photo-space">
                <img id="photo-img" crossorigin="anonymous" src="https://res.cloudinary.com/dmmll82la/image/upload/v1766047322/sp-club/passports/passport-1766047320820-328224026.png" alt="Technical Official Photo" data-default-src="https://res.cloudinary.com/dmmll82la/image/upload/v1766047322/sp-club/passports/passport-1766047320820-328224026.png">
            </div>
            <div class="info-fields">
                <div class="field empty" id="field-name"><span class="label">Name:</span> <span class="value" id="name"></span></div>
                <div class="field empty" id="field-sno"><span class="label">Reg. No:</span> <span class="value" id="sno"></span></div>
                <div class="field empty" id="field-uid"><span class="label">Aadhar No:</span> <span class="value" id="uid"></span></div>
                <div class="field empty" id="field-dob"><span class="label">Date of Birth:</span> <span class="value" id="dob"></span></div>
                <div class="field empty" id="field-grade"><span class="label">Grade:</span> <span class="value" id="grade"></span></div>
            </div>
        </div>

        <!-- Description text removed as requested; ID card will now only show
             core details and photo without the long paragraph. The element is
             no longer needed for layout, so it has been deleted. -->

        <div class="signature-area">
            
            <div class="sig-grid">
                <div class="sig-box">
                    <img class="sig-img" crossorigin="anonymous" src="https://res.cloudinary.com/dcqo5qt7b/image/upload/v1768749957/Tilak_Ram_Sahu_srluua.png" alt="Rajeev Signature">
                    <div class="sig-name">Rajeev Srivastav</div>
                    <div>President</div>
                    <div class="sig-line"></div>
                </div>
                
                <div class="sig-box">
                    <img class="sig-img" crossorigin="anonymous" src="https://res.cloudinary.com/dcqo5qt7b/image/upload/v1768749991/Mintoo_Thakur_Sign_cg8gxm.png" alt="Mintoo Signature">
                    <div class="sig-name">Mintoo Thakur</div>
                    <div>Secretary</div>
                    <div class="sig-line"></div>
                </div>

                <div class="sig-box">
                    <img class="sig-img" crossorigin="anonymous" src="https://res.cloudinary.com/dcqo5qt7b/image/upload/v1768749926/Pappu_Kumar_Yadav_Sign_bj2xlm.png" alt="Pappu Signature">
                    <div class="sig-name">Pappu Kr. Yadav</div>
                    <div>Chairman<br>
                        Refree Bord (DDKA)</div>
                    <div class="sig-line"></div>
                </div>
            </div>
        </div>

        <div class="footer-banner">
            DHANBAD DISTRICT KABADDI ASSOCIATION
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        (function(){
            const urlParams = new URLSearchParams(window.location.search);
            const API_BASE = urlParams.get('api') || '';
            const apiPrefix = API_BASE ? API_BASE.replace(/\/$/, '') : '';
            const toProxy = (url) => {
                if (!apiPrefix || !url) return url;
                if (url.includes('/api/proxy/image')) return url;
                if (!/^https?:/i.test(url)) return url;
                return `${apiPrefix}/api/proxy/image?url=${encodeURIComponent(url)}`;
            };
            const applyProxyToImg = (img) => {
                if (!img || !img.src) return;
                if (img.src.startsWith('data:')) return;
                if (img.src.includes('/api/proxy/image')) return;
                img.crossOrigin = 'anonymous';
                img.src = toProxy(img.src);
            };

            // Format long names for ID card: if the full name is long and
            // contains a middle "kumar", shorten that part to "Kr." so the
            // text fits better on the card (e.g. "Niranjan kumar Manato" â†’ "Niranjan Kr. Manato").
            function formatNameForIdCard(name) {
                const trimmed = (name || '').trim();
                if (!trimmed) return '';

                // Only abbreviate when the overall name is fairly long
                if (trimmed.length <= 20) return trimmed;

                const parts = trimmed.split(/\s+/);
                if (parts.length < 3) return trimmed;

                for (let i = 1; i < parts.length - 1; i++) {
                    if (/^kumar$/i.test(parts[i])) {
                        parts[i] = 'Kr.';
                        return parts.join(' ');
                    }
                }

                return trimmed;
            }
            function formatRegNo(sno) {
                const trimmed = (sno || '').trim();
                if (!trimmed) return '';
                const upper = trimmed.toUpperCase();
                if (/^DDKA-2026-/i.test(upper)) return trimmed;
                return `DDKA-2026-${trimmed}`;
            }
            function setFieldText(id, value) {
                const target = document.getElementById(id);
                const wrapper = document.getElementById('field-' + id);
                if (target) target.textContent = value || '';
                if (wrapper) {
                    if (value) wrapper.classList.remove('empty');
                    else wrapper.classList.add('empty');
                }
            }

            // Auto-fill from query parameters when opened from admin panel
            function applyQueryParams() {
                if (!window.location.search) return;
                try {
                    const qpSno = urlParams.get('sno');
                    const qpName = urlParams.get('name');
                    const qpUid = urlParams.get('uid');
                    const qpDob = urlParams.get('dob');
                    const qpGrade = urlParams.get('grade');
                    const qpPhoto = urlParams.get('photoUrl');
                    const qpDownload = urlParams.get('download');

                    const formattedName = formatNameForIdCard(qpName || '');

                    setFieldText('sno', formatRegNo(qpSno || ''));
                    setFieldText('name', formattedName);
                    setFieldText('uid', qpUid || '');
                    setFieldText('dob', qpDob || '');
                    setFieldText('grade', qpGrade || '');

                    const cert = document.getElementById('certified-name');
                    if (cert) {
                        cert.textContent = formattedName;
                        if (formattedName) cert.classList.remove('dotted-line');
                        else cert.classList.add('dotted-line');
                    }

                    if (qpPhoto) {
                        const imgEl = document.getElementById('photo-img');
                        if (imgEl && imgEl.tagName === 'IMG') {
                            imgEl.crossOrigin = 'anonymous';
                            imgEl.src = toProxy(qpPhoto);
                        }
                    }

                    window.__ddkaAutoDownload = qpDownload === '1' || qpDownload === 'true' ? 'jpg' : (qpDownload === 'pdf' ? 'pdf' : '');
                } catch (e) {
                    console.error('Failed to apply query params for ID card:', e);
                }
            }

            if (API_BASE) {
                document.querySelectorAll('img').forEach((img) => applyProxyToImg(img));
            }

            applyQueryParams();

            const photoImg = document.getElementById('photo-img');
            let defaultSrc = (photoImg && (photoImg.dataset && photoImg.dataset.defaultSrc)) || (photoImg && photoImg.src) || '';
            if (photoImg && API_BASE) {
                photoImg.crossOrigin = 'anonymous';
                defaultSrc = toProxy(defaultSrc);
                photoImg.src = toProxy(photoImg.src);
            }

            async function waitForImages() {
                const images = Array.from(document.images || []);
                await Promise.all(images.map((img) => {
                    if (img.complete) {
                        return img.decode ? img.decode().catch(() => {}) : Promise.resolve();
                    }
                    return new Promise((resolve) => {
                        img.addEventListener('load', resolve, { once: true });
                        img.addEventListener('error', resolve, { once: true });
                    });
                }));
            }

            async function exportJpg() {
                const el = document.querySelector('.id-card');
                if (!el) return;
                try {
                    const JPG_SCALE = 3;
                    const JPG_QUALITY = 0.95;
                    document.body.classList.add('exporting');
                    await waitForImages();
                    await new Promise(r => setTimeout(r, 80));
                    const canvas = await html2canvas(el, {scale: JPG_SCALE, backgroundColor: '#ffffff', useCORS: true});
                    const data = canvas.toDataURL('image/jpeg', JPG_QUALITY);
                    const a = document.createElement('a');
                    a.href = data;
                    a.download = 'ddka-id.jpg';
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                } catch (err) {
                    console.error('Failed to export image:', err);
                    const errMsg = err && (err.message || err.toString()) || 'Unknown error';
                    let msg = 'Failed to export image: ' + errMsg;
                    if (/tainted canvas|cross-origin|CORS|tainted/i.test(errMsg)) {
                        msg += '\n\nLikely cause: cross-origin images or CORS. Use proxied image URLs or enable CORS for external images.';
                    }
                    if (confirm(msg + '\n\nOpen print dialog instead?')) {
                        try { window.print(); } catch (e) { /* ignore */ }
                    } else {
                        alert(msg);
                    }
                } finally {
                    document.body.classList.remove('exporting');
                }
            }

            async function exportPdf() {
                const el = document.querySelector('.id-card');
                if (!el) return;
                try {
                    const PDF_SCALE = 3;
                    const PDF_QUALITY = 0.95;
                    document.body.classList.add('exporting');
                    await waitForImages();
                    await new Promise(r => setTimeout(r, 80));
                    const canvas = await html2canvas(el, {scale: PDF_SCALE, backgroundColor: '#ffffff', useCORS: true});
                    const imgData = canvas.toDataURL('image/jpeg', PDF_QUALITY);
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF({ orientation: 'portrait', unit: 'px', format: [canvas.width, canvas.height], compress: true });
                    pdf.addImage(imgData, 'JPEG', 0, 0, canvas.width, canvas.height, undefined, 'FAST');
                    pdf.save('ddka-id.pdf');
                } catch (err) {
                    console.error('Failed to export PDF:', err);
                    const errMsg = err && (err.message || err.toString()) || 'Unknown error';
                    let msg = 'Failed to export PDF: ' + errMsg;
                    if (/tainted canvas|cross-origin|CORS|tainted/i.test(errMsg)) {
                        msg += '\n\nLikely cause: cross-origin images or CORS. Use proxied image URLs or enable CORS for external images.';
                    }
                    if (confirm(msg + '\n\nOpen print dialog instead?')) {
                        try { window.print(); } catch (e) { /* ignore */ }
                    } else {
                        alert(msg);
                    }
                } finally {
                    document.body.classList.remove('exporting');
                }
            }

            if (window.__ddkaAutoDownload) {
                setTimeout(async () => {
                    if (window.__ddkaAutoDownload === 'pdf') await exportPdf();
                    else await exportJpg();
                    setTimeout(() => {
                        try { window.close(); } catch (e) { /* ignore */ }
                    }, 300);
                }, 200);
            }

        })();
    </script>
</body>
</html>